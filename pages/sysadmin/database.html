<LayoutContainer id="sa_database_PageContainer" style="width:100%;height:100%;margin:0px;padding:0;">
    <ContentPane id="sa_database_ContentPaneTop" region="top" style="width:100%;margin:0;padding:0;">
        <table width="100%" style="padding:0;text-align:left;border-top:none;border-left:none;border-right:none" class="dijitBorderContainer-child">
            <tr>
                <th>
                    <span style="margin-left:20px;margin-right:10px;vertical-align:middle;font-size:14px;font-weight:bold">DATABASE:</span>
                    <StackController style="" containerId="sadb_ContentContainer"></StackController>
                </th>
            </tr>
        </table>
    </ContentPane>
    <StackContainer id="sadb_ContentContainer" region="center" tabPosition="top" style="width:100%;height:100%; margin:5px;padding:0;">
        <TDocSimpleTable id="sadb_TDocDBCurrentChanges" title="Current changes" iconClass="dijitCheckBoxIcon" style="margin:0;padding:0;"></TDocSimpleTable>
        <TDocSimpleTable id="sadb_TDocDBChangeLog" title="Change log" iconClass="dijitCheckBoxIcon" style="margin:0;padding:0;"></TDocSimpleTable>
    </StackContainer>
</LayoutContainer>
<script type="text/javascript">                                                                             console.log("sysadmin database $$",$$);
    $$.request.getJSONData({url:"/sysadmin/database/get1", condition:null, showRequestErrorDialog:false, data:{}, consoleLog:true},
        function(result,error){
                                console.log("/sysadmin/database/get1",result,error);
        });

    var htDBCurrentChangesData={
        columns:[
            {data: "changeID", name: "changeID", width: 200, type: "text"},
            {data: "changeDatetime", name: "changeDatetime", width: 120, type:"text", datetimeFormat:"YYYY-MM-DD HH:mm:ss"},
            {data: "changeObj", name: "changeObj", width: 200, type: "text"},
            {data: "changeVal", name: "changeVal", width: 450, type: "text"},
            {data: "type", name: "type", width: 100, type: "text"},
            {data: "message", name: "message", width: 200, type: "text"}
        ],
        identifier:"changeID",
        items:[
            {changeID:"1",changeObj:"o1",changeVal:"QWErtyUIOP",type:"str",message:"msg1"},
            {changeID:"1-2",changeObj:"oo12",changeVal:"ASDfghJKL",type:"str",message:"msg22"},
            {changeID:"1-2-3",changeObj:"ooo123",changeVal:"1234567890",type:"str",message:"msg333"}
        ]
    };
//    $$.sadb_HTableDBCurrentChanges.updateContent(htDBCurrentChangesData);                     console.log("HTableDBCurrentChanges",$$.sadb_HTableDBCurrentChanges.getColumns(),$$.sadb_HTableDBCurrentChanges.getData());
                                                                                                            console.log("HTableDBCurrentChanges",$$.sadb_TDocDBCurrentChanges);

    $$.sadb_TDocDBCurrentChanges
            .setParams({titleText: "Data model current changes", dataURL: '/sysadmin/database/getCurrentChanges',buttonPrint: false, rightPane:{width:200}})
            .addTotalCountNumberBox("ИТОГО строк:", 140, {style: "font-weight:bold;", inputStyle: "width:40px;"})
            .addToolPane({title:"info",
                contentTableAction:function(params){
                    var info="";
                    if(params.contentTableSelectedRow){
                        info+="<b>changeID</b>: "+params.contentTableSelectedRow["changeID"];
                        info+="<br><b>changeDatetime</b>: "+params.contentTableSelectedRow["changeDatetime"];
                        info+="<br><b>changeObj</b>: "+params.contentTableSelectedRow["changeObj"];
                        info+="<br><b>changeVal</b>: "+params.contentTableSelectedRow["changeVal"];
                        info+="<br><b>type</b>: "+params.contentTableSelectedRow["type"];
                        info+="<br><b>message</b>: "+params.contentTableSelectedRow["message"];
                    }
                    params.thisToolPane.set("content",info);
                }
            })
            .addToolPane({title:"apply changes"})
            .addContentTableAction("applyChangesRowData",{
                startAction:function(contentTableRowsData, actionParams, startContentTableAction){
                    actionParams["finishedCounterByNoConnection"]=0;actionParams["finishedCounterByFailed"]=0;
                    if(actionParams.toolPanes&&actionParams.toolPanes[0]) actionParams.toolPanes[0].set("content","");
                    startContentTableAction();
                },
                tableRowAction:function(contentTableRowData, actionParams, contentTableUpdatedRowData, startNextAction, finishedAction){
                    var changeID = contentTableRowData.changeID;
                    var type = contentTableRowData.type;
                    if (type !== "new"){
                        startNextAction();
                        return;
                    }
                    //if type == "new"
                    $$.request.postJSONData({url:"/sysadmin/database/applyChange", condition:null, showRequestErrorDialog:false,
                                data: {"CHANGE_ID": changeID, appliedDatetime:moment().format("YYYY.MM.DD HH:mm:ss")}, consoleLog: true },
                            function(result,error){
                                var typeValue = type, changeMsg = null;
                                var infoMsgByParams= function(actionParams){
                                    if(!actionParams.toolPanes||!actionParams.toolPanes[0]) return;
                                    var infoToolPaneMsg=null;
                                    if(actionParams["finishedCounterByNoConnection"]>0)
                                        infoToolPaneMsg= "<b style='color:red'>FAILED because failed connent to server!</b>"+
                                                "<br><b style='color:red'>Try number "+actionParams["finishedCounterByNoConnection"]+" ...</b>";
                                    if(actionParams["finishedCounterByFailed"]>0) {
                                        if(!infoToolPaneMsg) infoToolPaneMsg=""; else infoToolPaneMsg+="<br>";
                                        infoToolPaneMsg+="<b style='color:red'>FAILED APPLIED!"
                                                +"<br>Reason:"+actionParams["failedMsg"]+"</b>";
                                    }
                                    if(infoToolPaneMsg) actionParams.toolPanes[0].set("content",infoToolPaneMsg);
                                };
                                if(error&&error.reqError){
                                    if(!actionParams["finishedCounterByNoConnection"]) actionParams["finishedCounterByNoConnection"]=0;
                                    actionParams["finishedCounterByNoConnection"]++;
                                    infoMsgByParams(actionParams);
                                    if(actionParams["finishedCounterByNoConnection"]>10) {
                                        $$.dialogs.showSimple({id:"errorDialog", title:"FAIL",
                                            content:"No connection to the server!"+((error.message)?"<br>Reason:"+error.message:""),
                                            btnOkLabel:"Close", width:350, style:"text-align:center"});
                                        finishedAction();
                                        return;
                                    }
                                    startNextAction(false);
                                    return;
                                }
                                if(error){
                                    changeMsg = "NOT APPLIED! Reason: " + error;
                                    actionParams["failedMsg"]=error;
                                    if(!actionParams["finishedCounterByFailed"]) actionParams["finishedCounterByFailed"]=0;
                                    actionParams["finishedCounterByFailed"]++;
                                }
                                actionParams["finishedCounterByNoConnection"]=0;
                                var resultItem = result["resultItem"];
                                if (resultItem) {
                                    if(resultItem.ID == changeID) typeValue = "applied";
                                    if(resultItem.CHANGE_MSG)
                                        changeMsg = (changeMsg == null) ? resultItem.CHANGE_MSG : changeMsg + " <br>Change message: " + resultItem.CHANGE_MSG;
                                    else {
                                        var changeMsgUnknown= "Result unknown!";
                                        changeMsg = (changeMsg == null) ? changeMsgUnknown:changeMsg+" <br>Change message:"+changeMsgUnknown;
                                    }
                                }
                                contentTableUpdatedRowData["message"]= changeMsg; contentTableUpdatedRowData["type"]= typeValue;
                                infoMsgByParams(actionParams);
                                if(actionParams["finishedCounterByFailed"]>0) {
                                    finishedAction();
                                    return;
                                }
                                startNextAction();
                            });
                },
                endAction:function(){
//                    if (sysadmin_database_PageContainer.getParent().updateDBState)
//                        sysadmin_database_PageContainer.getParent().updateDBState({revalidate:true});
                    if ($$.$parent.updateDBState) $$.$parent.updateDBState({revalidate:true});
                }
            })
            .addToolPaneActionButton("Apply all changes",{ btnStyle:"width:160px", contentTableActionName:"applyChangesRowData"})
            .addContentTablePopupMenuAction("Apply selected changes...", {contentTableActionName:"applyChangesRowData"})
            .addContentTablePopupMenuAction("Apply all changes...", {contentTableActionName:"applyChangesRowData",
                beforeContentTableAction:function(selectedTableContent, actionParams, startContentTableAction){
                    startContentTableAction(actionParams.thisInstance.getTableContent());
                }
            });
    $$.sadb_TDocDBChangeLog
            .setParams({titleText: "database change log", dataURL: '/sysadmin/database/getChangeLog', dataURLCondition:{"1~":1}, buttonPrint: false})
            .addTotalCountNumberBox("ИТОГО строк:", 140, {style: "font-weight:bold;", inputStyle: "width:40px;"});

    $$.sadb_TDocDBCurrentChanges.onShow= function(){
        if(!$$.sadb_TDocDBCurrentChanges.startedUp)$$.sadb_TDocDBCurrentChanges.startupDoc();
    };
    $$.sadb_TDocDBChangeLog.onShow= function(){
        if(!$$.sadb_TDocDBChangeLog.startedUp) $$.sadb_TDocDBChangeLog.startupDoc();
    };
    $$.sadb_TDocDBCurrentChanges.onShow();
</script>